<!DOCTYPE html>
<html>
<head>
    <title>ADS1110 实时数据监控</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f0f0f0;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .chart-container {
            position: relative;
            height: 400px;
            margin: 20px 0;
        }
        .status-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .status-card {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
        }
        .status-value {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }
        .status-label {
            color: #6c757d;
            margin-top: 5px;
        }
        .controls {
            margin: 20px 0;
            text-align: center;
        }
        button {
            padding: 10px 20px;
            margin: 0 10px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .start-btn {
            background-color: #28a745;
            color: white;
        }
        .stop-btn {
            background-color: #dc3545;
            color: white;
        }
        .clear-btn {
            background-color: #6c757d;
            color: white;
        }
        button:hover {
            opacity: 0.9;
        }
        .connection-status {
            text-align: center;
            margin-bottom: 20px;
            padding: 10px;
            border-radius: 5px;
        }
        .connected {
            background-color: #d4edda;
            color: #155724;
        }
        .disconnected {
            background-color: #f8d7da;
            color: #721c24;
        }
        .ip-input-container {
            text-align: center;
            margin: 20px 0;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        
        .ip-input {
            padding: 8px;
            width: 200px;
            margin-right: 10px;
            border: 1px solid #ced4da;
            border-radius: 4px;
        }
        
        .connect-btn {
            background-color: #007bff;
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .connect-btn:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ADS1110 实时数据监控</h1>
        
        <div class="ip-input-container">
            <input type="text" id="ipInput" class="ip-input" placeholder="输入设备IP地址" value="192.168.31.63">
            <button onclick="connectToDevice()" class="connect-btn">连接设备</button>
        </div>
        
        <div id="connectionStatus" class="connection-status disconnected">
            未连接到设备
        </div>

        <div class="status-panel">
            <div class="status-card">
                <div class="status-value" id="voltageValue">--</div>
                <div class="status-label">电压 (mV)</div>
            </div>
            <div class="status-card">
                <div class="status-value" id="timeValue">--:--:--</div>
                <div class="status-label">时间</div>
            </div>
            <div class="status-card">
                <div class="status-value" id="durationValue">--</div>
                <div class="status-label">持续时间 (秒)</div>
            </div>
        </div>

        <div class="chart-container">
            <canvas id="voltageChart"></canvas>
        </div>

        <div class="controls">
            <button class="start-btn" onclick="startRecording()">开始记录</button>
            <button class="stop-btn" onclick="stopRecording()">停止记录</button>
            <button class="clear-btn" onclick="clearData()">清除数据</button>
        </div>
    </div>

    <script>
        let ws;
        let chart;
        let dataPoints = [];
        let maxDataPoints = 100; // 最多显示100个数据点
        let isRecording = false;

        // 初始化图表
        function initChart() {
            const ctx = document.getElementById('voltageChart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: '电压 (mV)',
                        data: [],
                        borderColor: 'rgb(75, 192, 192)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false
                        }
                    }
                }
            });
        }

        // 连接到设备
        function connectToDevice() {
            const ipAddress = document.getElementById('ipInput').value.trim();
            if (!ipAddress) {
                alert('请输入设备IP地址');
                return;
            }
            
            // 关闭现有连接
            if (ws) {
                ws.close();
            }
            
            // 连接WebSocket
            const wsUrl = `ws://${ipAddress}/ws`;
            console.log('Connecting to WebSocket:', wsUrl);
            
            try {
                ws = new WebSocket(wsUrl);
                
                ws.onopen = function() {
                    console.log('WebSocket connected');
                    document.getElementById('connectionStatus').className = 'connection-status connected';
                    document.getElementById('connectionStatus').textContent = '已连接到设备';
                    document.querySelector('.connect-btn').textContent = '已连接';
                    document.querySelector('.connect-btn').disabled = true;
                };
                
                ws.onclose = function() {
                    console.log('WebSocket disconnected');
                    document.getElementById('connectionStatus').className = 'connection-status disconnected';
                    document.getElementById('connectionStatus').textContent = '未连接到设备';
                    document.querySelector('.connect-btn').textContent = '连接设备';
                    document.querySelector('.connect-btn').disabled = false;
                };
                
                ws.onerror = function(error) {
                    console.error('WebSocket error:', error);
                    document.getElementById('connectionStatus').className = 'connection-status disconnected';
                    document.getElementById('connectionStatus').textContent = '连接错误';
                    document.querySelector('.connect-btn').textContent = '重试连接';
                    document.querySelector('.connect-btn').disabled = false;
                };
                
                ws.onmessage = function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        console.log('Received data:', data);
                        updateDisplay(data);
                    } catch (error) {
                        console.error('Error parsing message:', error);
                    }
                };
            } catch (error) {
                console.error('Error creating WebSocket:', error);
                document.getElementById('connectionStatus').className = 'connection-status disconnected';
                document.getElementById('connectionStatus').textContent = '连接错误: ' + error.message;
            }
        }

        // 更新显示
        function updateDisplay(data) {
            try {
                // 更新状态面板
                document.getElementById('voltageValue').textContent = data.voltage.toFixed(3);
                document.getElementById('timeValue').textContent = data.timestamp;
                document.getElementById('durationValue').textContent = data.duration;

                // 更新图表
                if (isRecording) {
                    dataPoints.push({
                        time: data.timestamp,
                        voltage: data.voltage
                    });

                    // 限制数据点数量
                    if (dataPoints.length > maxDataPoints) {
                        dataPoints.shift();
                    }

                    // 更新图表数据
                    chart.data.labels = dataPoints.map(point => point.time);
                    chart.data.datasets[0].data = dataPoints.map(point => point.voltage);
                    chart.update();
                }
            } catch (error) {
                console.error('Error updating display:', error);
            }
        }

        // 开始记录
        function startRecording() {
            isRecording = true;
            document.querySelector('.start-btn').disabled = true;
            document.querySelector('.stop-btn').disabled = false;
        }

        // 停止记录
        function stopRecording() {
            isRecording = false;
            document.querySelector('.start-btn').disabled = false;
            document.querySelector('.stop-btn').disabled = true;
        }

        // 清除数据
        function clearData() {
            dataPoints = [];
            chart.data.labels = [];
            chart.data.datasets[0].data = [];
            chart.update();
        }

        // 页面加载完成后初始化
        window.onload = function() {
            initChart();
            // 不再自动连接，等待用户点击连接按钮
        };
    </script>
</body>
</html> 